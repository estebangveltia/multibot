<h1>Dashboard <%= tenant ? ('- ' + tenant.name) : '' %></h1>

<form method="GET" class="filters">
  <label>Desde <input type="date" name="from" value="<%= from %>"/></label>
  <label>Hasta <input type="date" name="to" value="<%= to %>"/></label>
  <button class="btn" type="submit">Aplicar</button>
</form>

<div class="kpi-cards">
  <div class="kpi"><h3>Conversaciones</h3><div class="value"><%= kpis.conversations %></div></div>
  <div class="kpi"><h3>Usuarios</h3><div class="value"><%= kpis.users %></div></div>
  <div class="kpi"><h3>Mensajes</h3><div class="value"><%= kpis.messages %></div></div>
  <div class="kpi"><h3>Fallbacks</h3><div class="value"><%= kpis.fallbacks %></div></div>
  <div class="kpi"><h3>Msgs/Conv</h3><div class="value"><%= kpis.avg_per_conv.toFixed(2) %></div></div>
</div>

<canvas id="lineChart" height="120"></canvas>

<script>
const rows = <%- JSON.stringify(rows) %>;
const byDay = {};
rows.forEach(r => {
  const d = r.day.substring(0,10);
  if (!byDay[d]) byDay[d] = { conversations:0, users:0, messages:0, fallbacks:0 };
  byDay[d].conversations += r.conversations;
  byDay[d].users += r.users;
  byDay[d].messages += r.messages;
  byDay[d].fallbacks += r.fallbacks;
});
const labels = Object.keys(byDay).sort();
const conversations = labels.map(d => byDay[d].conversations);
const users = labels.map(d => byDay[d].users);
const messages = labels.map(d => byDay[d].messages);

new Chart(document.getElementById('lineChart'), {
  type: 'line',
  data: {
    labels,
    datasets: [
      { label: 'Conversaciones', data: conversations },
      { label: 'Usuarios', data: users },
      { label: 'Mensajes', data: messages }
    ]
  }
});
</script>
